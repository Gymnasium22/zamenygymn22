<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Гимназия: Замена Учителей</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Google Fonts: Manrope -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Manrope', sans-serif; 
            background-color: #f8fafc;
        }
        input, select, textarea {
            background-color: #ffffff !important;
            color: #0f172a !important;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        /* Drag and Drop styles */
        .draggable-item {
            cursor: grab;
        }
        .draggable-item:active {
            cursor: grabbing;
        }
        .dragging {
            opacity: 0.5;
            border: 2px dashed #6366f1;
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden selection:bg-indigo-100 selection:text-indigo-700">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        
        // --- EMBEDDED ICONS (Guaranteed to work) ---
        const Icons = {
            School: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="m4 6 8-4 8 4"/><path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2"/><path d="M14 22v-4a2 2 0 0 0-4 0v4"/><path d="M18 5v17"/><path d="M6 5v17"/><circle cx="12" cy="9" r="2"/></svg>,
            Calendar: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            ArrowLeftRight: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3 4 7l4 4"/><path d="M4 7h16"/><path d="m16 21 4-4-4-4"/><path d="M20 17H4"/></svg>,
            Library: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="m16 6 4 14"/><path d="M12 6v14"/><path d="M8 8v12"/><path d="M4 4v16"/></svg>,
            Download: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            User: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Book: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>,
            GraduationCap: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>,
            Plus: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Edit2: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Trash2: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            X: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            ChevronDown: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            UserX: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="17" x2="22" y1="8" y2="13"/><line x1="22" x2="17" y1="8" y2="13"/></svg>,
            Check: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            List: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Coffee: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>,
            UserCheck: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>,
            Search: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Info: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Star: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            ImageDown: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M10.3 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10l-3.1-3.1a2 2 0 0 0-2.814.014L6 21"/><circle cx="9" cy="9" r="2"/><path d="m14 19 3 3v-5.5"/><path d="m17 22 3-3"/></svg>,
            Save: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Upload: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Filter: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            GripVertical: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
            FileSpreadsheet: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
            Briefcase: (props) => <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
        };
        
        const Icon = ({ name, size = 20, className = "", strokeWidth, fill }) => {
            const IconComp = Icons[name];
            if (!IconComp) return <span className="text-red-500 font-bold">?</span>;
            return <IconComp width={size} height={size} className={className} strokeWidth={strokeWidth} fill={fill || "none"} />;
        };

        // --- Types & Constants ---
        const DayOfWeek = {
            Monday: 'Пн',
            Tuesday: 'Вт',
            Wednesday: 'Ср',
            Thursday: 'Чт',
            Friday: 'Пт',
            Saturday: 'Сб'
        };

        const Shift = {
            First: '1 смена',
            Second: '2 смена'
        };

        // DIRECTIONS removed as we now use manual input

        const SHIFT_PERIODS = {
            [Shift.First]: [1, 2, 3, 4, 5, 6, 7],
            [Shift.Second]: [0, 1, 2, 3, 4, 5, 6]
        };

        const DAYS = [
            DayOfWeek.Monday,
            DayOfWeek.Tuesday,
            DayOfWeek.Wednesday,
            DayOfWeek.Thursday,
            DayOfWeek.Friday,
            DayOfWeek.Saturday
        ];

        const STORAGE_KEY = 'gymnasium_data_v4';
        
        const INITIAL_DATA = {
            subjects: [
                { id: 's1', name: 'Математика', color: '#e0e7ff' },
                { id: 's2', name: 'Русский язык', color: '#dcfce7' },
                { id: 's3', name: 'Литература', color: '#fef9c3' },
                { id: 's4', name: 'Физика', color: '#f3e8ff' },
                { id: 's5', name: 'История', color: '#ffedd5' },
                { id: 's6', name: 'Информатика', color: '#cffafe' },
            ],
            teachers: [
                { id: 't1', name: 'Иванова Анна Сергеевна', subjectIds: ['s1', 's4'], unavailableDates: [] },
                { id: 't2', name: 'Петров Борис Михайлович', subjectIds: ['s2', 's3'], unavailableDates: [] },
            ],
            classes: [
                { id: 'c1', name: '5А', shift: Shift.First },
                { id: 'c2', name: '5Б', shift: Shift.First },
                { id: 'c3', name: '6А', shift: Shift.Second },
            ],
            schedule: [],
            substitutions: []
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const saveData = (data) => {
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) {}
        };

        const loadData = () => {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) return JSON.parse(stored);
            } catch (e) {}
            return INITIAL_DATA;
        };

        // --- Components ---
        const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-lg' }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/20 p-4 backdrop-blur-sm animate-fade-in">
                    <div className={`bg-white rounded-2xl shadow-2xl w-full ${maxWidth} flex flex-col max-h-[90vh] ring-1 ring-black/5`}>
                        <div className="flex items-center justify-between px-6 py-5 border-b border-slate-100">
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 transition-colors p-1 rounded-full hover:bg-slate-100">
                                <Icon name="X" size={24} />
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const Tabs = ({ activeTab, onChange, tabs }) => {
            return (
                <div className="px-6 pt-2 bg-white border-b border-slate-100 flex gap-6 overflow-x-auto">
                    {tabs.map((tab) => (
                        <button
                            key={tab.id}
                            onClick={() => onChange(tab.id)}
                            className={`flex items-center gap-2.5 pb-4 px-1 text-sm font-bold transition-all duration-300 border-b-2 whitespace-nowrap
                                ${activeTab === tab.id
                                    ? 'border-indigo-600 text-indigo-600'
                                    : 'border-transparent text-slate-500 hover:text-slate-800 hover:border-slate-300'
                                }`}
                        >
                            {tab.icon}
                            {tab.label}
                        </button>
                    ))}
                </div>
            );
        };

        // --- Views ---
        const DirectoryView = ({ data, setData }) => {
            const [activeSubTab, setActiveSubTab] = useState('teachers');
            const [isModalOpen, setIsModalOpen] = useState(false);
            
            const [tempTeacher, setTempTeacher] = useState({ subjectIds: [] });
            const [tempSubject, setTempSubject] = useState({ color: '#e0e7ff' });
            const [tempClass, setTempClass] = useState({ shift: Shift.First });

            const [draggedItemIndex, setDraggedItemIndex] = useState(null);

            // Drag and Drop Handlers
            const handleDragStart = (index) => {
                setDraggedItemIndex(index);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
            };

            const handleDrop = (dropIndex, type) => {
                if (draggedItemIndex === null) return;
                
                const newData = { ...data };
                let list;
                if (type === 'teachers') list = newData.teachers;
                else if (type === 'subjects') list = newData.subjects;
                else list = newData.classes;

                const item = list.splice(draggedItemIndex, 1)[0];
                list.splice(dropIndex, 0, item);

                if (type === 'teachers') newData.teachers = list;
                else if (type === 'subjects') newData.subjects = list;
                else newData.classes = list;

                setData(newData);
                saveData(newData);
                setDraggedItemIndex(null);
            };

            const handleSave = () => {
                const newData = { ...data };
                if (activeSubTab === 'teachers') {
                    if (tempTeacher.id) newData.teachers = data.teachers.map(t => t.id === tempTeacher.id ? { ...t, ...tempTeacher } : t);
                    else newData.teachers = [...data.teachers, { ...tempTeacher, id: generateId(), unavailableDates: [] }];
                } else if (activeSubTab === 'subjects') {
                    if (tempSubject.id) newData.subjects = data.subjects.map(s => s.id === tempSubject.id ? { ...s, ...tempSubject } : s);
                    else newData.subjects = [...data.subjects, { ...tempSubject, id: generateId() }];
                } else {
                    if (tempClass.id) newData.classes = data.classes.map(c => c.id === tempClass.id ? { ...c, ...tempClass } : c);
                    else newData.classes = [...data.classes, { ...tempClass, id: generateId() }];
                }
                setData(newData);
                saveData(newData);
                setIsModalOpen(false);
                resetForms();
            };

            const resetForms = () => {
                setTempTeacher({ subjectIds: [] });
                setTempSubject({ color: '#e0e7ff' });
                setTempClass({ shift: Shift.First });
            };

            const handleDelete = (id, type) => {
                if (!window.confirm('Вы уверены?')) return;
                const newData = { ...data };
                if (type === 'teachers') newData.teachers = data.teachers.filter(t => t.id !== id);
                if (type === 'subjects') newData.subjects = data.subjects.filter(s => s.id !== id);
                if (type === 'classes') newData.classes = data.classes.filter(c => c.id !== id);
                setData(newData);
                saveData(newData);
            };

            const inputClass = "w-full border border-slate-200 rounded-xl px-4 py-2.5 bg-white text-slate-800 placeholder-slate-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all";

            const renderContent = () => {
                if (activeSubTab === 'teachers') {
                    return (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
                            {data.teachers.map((t, index) => (
                                <div 
                                    key={t.id} 
                                    draggable
                                    onDragStart={() => handleDragStart(index)}
                                    onDragOver={handleDragOver}
                                    onDrop={() => handleDrop(index, 'teachers')}
                                    className={`bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow flex flex-col group draggable-item ${draggedItemIndex === index ? 'dragging' : ''}`}
                                >
                                    <div className="flex justify-between items-start mb-3">
                                        <div className="flex items-center gap-2">
                                            <div className="cursor-grab text-slate-300 hover:text-slate-500"><Icon name="GripVertical" size={20} /></div>
                                            <div className="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center">
                                                <Icon name="User" size={20} />
                                            </div>
                                        </div>
                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => { setTempTeacher(t); setIsModalOpen(true); }} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full"><Icon name="Edit2" size={16}/></button>
                                            <button onClick={() => handleDelete(t.id, 'teachers')} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-full"><Icon name="Trash2" size={16}/></button>
                                        </div>
                                    </div>
                                    <h3 className="font-bold text-slate-800 mb-1">{t.name}</h3>
                                    <div className="flex flex-wrap gap-1 mt-auto">
                                        {t.subjectIds.map(sid => {
                                            const subj = data.subjects.find(s => s.id === sid);
                                            return subj ? <span key={sid} className="px-2 py-1 rounded-md text-xs font-medium" style={{backgroundColor: subj.color, color: '#334155'}}>{subj.name}</span> : null;
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    );
                }
                if (activeSubTab === 'subjects') {
                    return (
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pb-20">
                            {data.subjects.map((s, index) => (
                                <div 
                                    key={s.id} 
                                    draggable
                                    onDragStart={() => handleDragStart(index)}
                                    onDragOver={handleDragOver}
                                    onDrop={() => handleDrop(index, 'subjects')}
                                    className={`bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between group hover:border-slate-200 draggable-item ${draggedItemIndex === index ? 'dragging' : ''}`}
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="cursor-grab text-slate-300 hover:text-slate-500"><Icon name="GripVertical" size={16} /></div>
                                        <div className="w-8 h-8 rounded-full shadow-inner" style={{ backgroundColor: s.color }}></div>
                                        <span className="font-semibold text-slate-700">{s.name}</span>
                                    </div>
                                    <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onClick={() => { setTempSubject(s); setIsModalOpen(true); }} className="p-1.5 text-slate-400 hover:text-indigo-600 rounded-full"><Icon name="Edit2" size={16}/></button>
                                        <button onClick={() => handleDelete(s.id, 'subjects')} className="p-1.5 text-slate-400 hover:text-red-600 rounded-full"><Icon name="Trash2" size={16}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    );
                }
                if (activeSubTab === 'classes') {
                    return (
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 pb-20">
                            {data.classes.map((c, index) => (
                                <div 
                                    key={c.id} 
                                    draggable
                                    onDragStart={() => handleDragStart(index)}
                                    onDragOver={handleDragOver}
                                    onDrop={() => handleDrop(index, 'classes')}
                                    className={`bg-white p-4 rounded-2xl border border-slate-100 shadow-sm text-center relative group hover:shadow-md transition-all draggable-item ${draggedItemIndex === index ? 'dragging' : ''}`}
                                >
                                    <div className="absolute left-2 top-2 cursor-grab text-slate-300 hover:text-slate-500"><Icon name="GripVertical" size={14} /></div>
                                    <div className="text-2xl font-bold text-slate-800 mb-1 flex flex-col items-center justify-center">
                                        {c.name}
                                    </div>
                                    <div className={`text-xs font-bold px-2 py-0.5 rounded-full inline-block ${c.shift === Shift.First ? 'bg-blue-50 text-blue-600' : 'bg-orange-50 text-orange-600'}`}>
                                        {c.shift === Shift.First ? 'I' : 'II'} смена
                                    </div>
                                    <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onClick={() => { setTempClass(c); setIsModalOpen(true); }} className="p-1 text-slate-400 hover:text-indigo-600"><Icon name="Edit2" size={14}/></button>
                                        <button onClick={() => handleDelete(c.id, 'classes')} className="p-1 text-slate-400 hover:text-red-600"><Icon name="Trash2" size={14}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    );
                }
            };

            return (
                <div className="flex flex-col h-full bg-slate-50/50 overflow-hidden">
                    <div className="px-6 py-6 max-w-7xl mx-auto w-full flex-1 flex flex-col min-h-0">
                        <div className="flex flex-wrap items-center justify-between gap-4 mb-8 shrink-0">
                            <div className="flex p-1 bg-white rounded-xl shadow-sm border border-slate-100">
                                <button onClick={() => setActiveSubTab('teachers')} className={`px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeSubTab === 'teachers' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}><Icon name="User" size={18}/> Учителя</button>
                                <button onClick={() => setActiveSubTab('subjects')} className={`px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeSubTab === 'subjects' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}><Icon name="Book" size={18}/> Предметы</button>
                                <button onClick={() => setActiveSubTab('classes')} className={`px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeSubTab === 'classes' ? 'bg-indigo-50 text-indigo-600 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}><Icon name="GraduationCap" size={18}/> Классы</button>
                            </div>
                            <button onClick={() => { resetForms(); setIsModalOpen(true); }} className="flex items-center gap-2 bg-slate-900 text-white px-6 py-3 rounded-xl hover:bg-slate-800 transition shadow-lg shadow-slate-200 font-semibold">
                                <Icon name="Plus" size={20} strokeWidth={2.5} /> Добавить
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                            {renderContent()}
                        </div>
                    </div>

                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={activeSubTab === 'teachers' ? 'Добавить учителя' : activeSubTab === 'subjects' ? 'Добавить предмет' : 'Добавить класс'}>
                        <div className="space-y-5">
                            {activeSubTab === 'teachers' && (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5 tracking-wide">ФИО Учителя</label>
                                        <input type="text" className={inputClass} value={tempTeacher.name || ''} onChange={e => setTempTeacher({...tempTeacher, name: e.target.value})} placeholder="ФИО" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5 tracking-wide">Предметы</label>
                                        <div className="max-h-48 overflow-y-auto border border-slate-200 rounded-xl p-2 grid grid-cols-1 gap-1 bg-white custom-scrollbar">
                                            {data.subjects.map(s => (
                                                <label key={s.id} className="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors">
                                                    <input type="checkbox" className="w-5 h-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" checked={tempTeacher.subjectIds?.includes(s.id)} onChange={e => {
                                                        const current = tempTeacher.subjectIds || [];
                                                        setTempTeacher({...tempTeacher, subjectIds: e.target.checked ? [...current, s.id] : current.filter(id => id !== s.id)});
                                                    }} />
                                                    <span className="text-sm font-medium text-slate-700">{s.name}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </>
                            )}
                            {activeSubTab === 'subjects' && (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5 tracking-wide">Название</label>
                                        <input type="text" className={inputClass} value={tempSubject.name || ''} onChange={e => setTempSubject({...tempSubject, name: e.target.value})} placeholder="Математика" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5 tracking-wide">Цвет</label>
                                        <input type="color" className="h-12 w-24 p-1 border border-slate-200 rounded-xl cursor-pointer bg-white" value={tempSubject.color || '#ffffff'} onChange={e => setTempSubject({...tempSubject, color: e.target.value})} />
                                    </div>
                                </>
                            )}
                            {activeSubTab === 'classes' && (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5 tracking-wide">Название</label>
                                        <input type="text" className={inputClass} value={tempClass.name || ''} onChange={e => setTempClass({...tempClass, name: e.target.value})} placeholder="5А" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5 tracking-wide">Смена</label>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={() => setTempClass({...tempClass, shift: Shift.First})} className={`p-3 rounded-xl border text-sm font-bold transition-all ${tempClass.shift === Shift.First ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`}>1 смена</button>
                                            <button onClick={() => setTempClass({...tempClass, shift: Shift.Second})} className={`p-3 rounded-xl border text-sm font-bold transition-all ${tempClass.shift === Shift.Second ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`}>2 смена</button>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                        <div className="flex justify-end gap-3 mt-8 pt-5 border-t border-slate-100">
                            <button onClick={() => setIsModalOpen(false)} className="px-6 py-2.5 text-slate-500 hover:bg-slate-100 rounded-xl text-sm font-bold transition-colors">Отмена</button>
                            <button onClick={handleSave} className="px-6 py-2.5 bg-slate-900 text-white rounded-xl hover:bg-slate-800 text-sm font-bold transition-all shadow-lg shadow-slate-200">Сохранить</button>
                        </div>
                    </Modal>
                </div>
            );
        };

        const ScheduleView = ({ data, setData }) => {
            const [selectedShift, setSelectedShift] = useState(Shift.First);
            const [selectedDay, setSelectedDay] = useState(DayOfWeek.Monday);
            const [isEditorOpen, setIsEditorOpen] = useState(false);
            const [editingCell, setEditingCell] = useState(null);
            const [tempItem, setTempItem] = useState({});
            
            // Filter States
            const [filterType, setFilterType] = useState('class'); // class, teacher, subject
            const [filterValue, setFilterValue] = useState('');

            const currentPeriods = SHIFT_PERIODS[selectedShift];
            
            // Filter logic
            const getVisibleRows = () => {
                if (filterType === 'class') {
                    if (filterValue) {
                         return data.classes.filter(c => c.id === filterValue && (c.shift || Shift.First) === selectedShift);
                    }
                    return data.classes.filter(c => (c.shift || Shift.First) === selectedShift);
                }
                if (filterType === 'teacher') {
                     if (!filterValue) return [];
                    const matchingClassIds = data.schedule
                        .filter(s => s.day === selectedDay && s.shift === selectedShift && s.teacherId === filterValue)
                        .map(s => s.classId);
                    return data.classes.filter(c => (c.shift || Shift.First) === selectedShift && matchingClassIds.includes(c.id));
                }
                if (filterType === 'subject') {
                    if (!filterValue) return [];
                    const matchingClassIds = data.schedule
                        .filter(s => s.day === selectedDay && s.shift === selectedShift && s.subjectId === filterValue)
                        .map(s => s.classId);
                    return data.classes.filter(c => (c.shift || Shift.First) === selectedShift && matchingClassIds.includes(c.id));
                }
                return data.classes.filter(c => (c.shift || Shift.First) === selectedShift);
            };

            const visibleClasses = getVisibleRows();

            // Returns ARRAY of lessons for this cell
            const getScheduleItems = (classId, period) => {
                return data.schedule.filter(s => s.classId === classId && s.period === period && s.day === selectedDay && s.shift === selectedShift);
            };

            // Open modal to EDIT existing item
            const handleEditItem = (item) => {
                setEditingCell({ classId: item.classId, period: item.period });
                setTempItem({ ...item });
                setIsEditorOpen(true);
            };

            // Open modal to ADD NEW item to cell
            const handleAddItem = (classId, period) => {
                setEditingCell({ classId, period });
                setTempItem({ classId, period, day: selectedDay, shift: selectedShift });
                setIsEditorOpen(true);
            };

            const handleSaveItem = () => {
                if (!tempItem.subjectId || !tempItem.teacherId) { alert("Заполните данные"); return; }
                const newData = { ...data };
                
                if (tempItem.id) {
                    // Update existing lesson
                    newData.schedule = newData.schedule.map(s => s.id === tempItem.id ? tempItem : s);
                } else {
                    // Add new lesson
                    newData.schedule.push({ ...tempItem, id: generateId(), day: selectedDay, shift: selectedShift, classId: editingCell.classId, period: editingCell.period });
                }
                
                setData(newData);
                saveData(newData);
                setIsEditorOpen(false);
            };

            const handleDeleteItem = () => {
                if (!tempItem.id) return;
                const newData = { ...data };
                newData.schedule = newData.schedule.filter(s => s.id !== tempItem.id);
                setData(newData);
                saveData(newData);
                setIsEditorOpen(false);
            };

            const handleExportStyledExcel = () => {
                let html = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                    <head>
                        <meta charset="utf-8">
                        <style>
                            table { border-collapse: collapse; width: 100%; }
                            th { background-color: #f1f5f9; border: 1px solid #cbd5e1; padding: 10px; font-weight: bold; text-align: center; }
                            td { border: 1px solid #cbd5e1; padding: 5px; vertical-align: top; }
                            .header-cell { background-color: #e2e8f0; font-size: 14px; }
                            .subject { font-weight: bold; font-size: 12px; }
                            .teacher { font-size: 10px; color: #475569; }
                            .room { font-size: 10px; color: #94a3b8; text-align: right; }
                            .shift-header { background-color: #4f46e5; color: white; font-size: 16px; font-weight: bold; padding: 10px; text-align: left; }
                            .day-header { background-color: #e0e7ff; font-weight: bold; padding: 5px; text-align: center; font-size: 14px; }
                            .sub-item { border-bottom: 1px solid #e2e8f0; margin-bottom: 4px; padding-bottom: 4px; }
                        </style>
                    </head>
                    <body>
                        <table>
                `;

                DAYS.forEach(day => {
                    html += `<tr><td colspan="8" class="day-header">${day}</td></tr>`;
                    [Shift.First, Shift.Second].forEach(shift => {
                        const classes = data.classes.filter(c => c.shift === shift);
                        if (classes.length === 0) return;

                        const periods = SHIFT_PERIODS[shift];
                        html += `<tr><td colspan="8" class="shift-header">${shift}</td></tr>`;
                        html += `<tr><th class="header-cell">Класс</th>`;
                        periods.forEach(p => html += `<th class="header-cell">${p} урок</th>`);
                        html += `</tr>`;

                        classes.forEach(cls => {
                            html += `<tr><td style="font-weight:bold; text-align:center; font-size: 14px;">${cls.name}</td>`;
                            periods.forEach(p => {
                                const items = data.schedule.filter(s => s.classId === cls.id && s.day === day && s.shift === shift && s.period === p);
                                html += `<td>`;
                                items.forEach(item => {
                                    const subj = data.subjects.find(s => s.id === item.subjectId);
                                    const teach = data.teachers.find(t => t.id === item.teacherId);
                                    html += `<div class="sub-item" style="background-color: ${subj?.color || '#ffffff'}40">
                                                <div class="subject">${subj?.name || ''} ${item.direction ? `(${item.direction})` : ''}</div>
                                                <div class="teacher">${teach?.name || ''}</div>
                                                ${item.roomId ? `<div class="room">Каб. ${item.roomId}</div>` : ''}
                                             </div>`;
                                });
                                html += `</td>`;
                            });
                            html += `</tr>`;
                        });
                    });
                    html += `<tr><td colspan="8" style="height: 20px;"></td></tr>`;
                });

                html += `</table></body></html>`;
                const blob = new Blob([html], { type: "application/vnd.ms-excel" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = "Полное_Расписание_Гимназия.xls";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const recommendedTeachers = tempItem.subjectId ? data.teachers.filter(t => t.subjectIds.includes(tempItem.subjectId)) : [];
            const otherTeachers = tempItem.subjectId ? data.teachers.filter(t => !t.subjectIds.includes(tempItem.subjectId)) : data.teachers;

            return (
                <div className="flex flex-col h-full bg-slate-50/50 p-6">
                    <div className="flex flex-wrap gap-4 items-center justify-between bg-white p-2 rounded-2xl shadow-sm border border-slate-100 mb-6 max-w-7xl mx-auto w-full">
                        <div className="flex gap-4 items-center flex-wrap">
                            <div className="bg-slate-100 p-1 rounded-xl flex">
                                <button onClick={() => setSelectedShift(Shift.First)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${selectedShift === Shift.First ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>1 смена</button>
                                <button onClick={() => setSelectedShift(Shift.Second)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${selectedShift === Shift.Second ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>2 смена</button>
                            </div>
                            <div className="h-8 w-px bg-slate-200 mx-2 hidden sm:block"></div>
                            <div className="flex overflow-x-auto pb-1 gap-1 custom-scrollbar">
                                {DAYS.map(day => (
                                    <button key={day} onClick={() => setSelectedDay(day)} className={`px-4 py-2 rounded-xl text-sm font-bold transition-all ${selectedDay === day ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'text-slate-500 hover:bg-slate-100'}`}>{day}</button>
                                ))}
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-2 w-full sm:w-auto">
                            <button onClick={handleExportStyledExcel} className="px-3 py-2 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors" title="Скачать красивый Excel">
                                <Icon name="FileSpreadsheet" size={18} /> <span className="hidden lg:inline">Excel</span>
                            </button>
                            <div className="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg p-1">
                                <span className="pl-2 text-slate-400"><Icon name="Filter" size={16} /></span>
                                <select 
                                    className="bg-transparent border-none text-sm font-semibold text-slate-700 outline-none w-24"
                                    value={filterType}
                                    onChange={(e) => { setFilterType(e.target.value); setFilterValue(''); }}
                                >
                                    <option value="class">Класс</option>
                                    <option value="teacher">Учитель</option>
                                    <option value="subject">Предмет</option>
                                </select>
                            </div>
                            
                             {filterType === 'class' && (
                                <select 
                                    className="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white outline-none focus:border-indigo-500 w-40"
                                    value={filterValue}
                                    onChange={(e) => setFilterValue(e.target.value)}
                                >
                                    <option value="">Все</option>
                                    {data.classes.filter(c => c.shift === selectedShift).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            )}

                            {filterType === 'teacher' && (
                                <select 
                                    className="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white outline-none focus:border-indigo-500 w-40"
                                    value={filterValue}
                                    onChange={(e) => setFilterValue(e.target.value)}
                                >
                                    <option value="">Все</option>
                                    {data.teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                </select>
                            )}
                            {filterType === 'subject' && (
                                <select 
                                    className="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white outline-none focus:border-indigo-500 w-40"
                                    value={filterValue}
                                    onChange={(e) => setFilterValue(e.target.value)}
                                >
                                    <option value="">Все</option>
                                    {data.subjects.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            )}
                        </div>
                    </div>

                    <div className="flex-1 bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden flex flex-col max-w-7xl mx-auto w-full">
                        <div className="overflow-auto flex-1 custom-scrollbar">
                            <table className="w-full border-collapse min-w-[1000px]">
                                <thead className="bg-slate-50 sticky top-0 z-20">
                                    <tr>
                                        <th className="p-4 border-b border-r border-slate-100 text-left text-xs font-extrabold text-slate-400 uppercase w-24 sticky left-0 bg-slate-50 z-30">Класс</th>
                                        {currentPeriods.map(p => <th key={p} className="p-4 border-b border-slate-100 text-center text-xs font-extrabold text-slate-400 uppercase min-w-[160px]">{p} урок</th>)}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {visibleClasses.length > 0 ? visibleClasses.map(cls => (
                                        <tr key={cls.id} className="group">
                                            <td className="p-4 border-r border-slate-100 font-black text-xl text-slate-700 sticky left-0 bg-white z-10 text-center group-hover:bg-slate-50 transition-colors">{cls.name}</td>
                                            {currentPeriods.map(p => {
                                                const items = getScheduleItems(cls.id, p);
                                                
                                                // Dimming Logic
                                                const hasMatch = items.length > 0 && (
                                                    (filterType === 'teacher' && filterValue ? items.some(i => i.teacherId === filterValue) : true) &&
                                                    (filterType === 'subject' && filterValue ? items.some(i => i.subjectId === filterValue) : true)
                                                );
                                                const isDimmed = (filterType === 'teacher' && filterValue) || (filterType === 'subject' && filterValue) ? !hasMatch : false;

                                                return (
                                                    <td key={p} className={`p-2 border-r border-slate-50 h-28 align-top transition-all relative hover:bg-slate-50 ${isDimmed ? 'opacity-20' : ''}`}>
                                                        <div className="h-full flex flex-col gap-1">
                                                            {items.map(item => {
                                                                const subject = data.subjects.find(s => s.id === item.subjectId);
                                                                const teacher = data.teachers.find(t => t.id === item.teacherId);
                                                                return (
                                                                    <div 
                                                                        key={item.id} 
                                                                        onClick={(e) => { e.stopPropagation(); handleEditItem(item); }}
                                                                        className="rounded-lg p-2 text-xs shadow-sm hover:shadow-md cursor-pointer border border-slate-100 flex flex-col gap-0.5 flex-1" 
                                                                        style={{ backgroundColor: subject?.color ? subject.color + '40' : '#f1f5f9' }}
                                                                    >
                                                                        <div className="flex justify-between items-center gap-1">
                                                                            <div className="font-bold text-slate-800 line-clamp-1">{subject?.name}</div>
                                                                            {item.direction && <div className="text-[9px] px-1 rounded bg-white/80 font-bold text-slate-600 whitespace-nowrap">{item.direction}</div>}
                                                                        </div>
                                                                        <div className="flex justify-between items-center gap-1">
                                                                            <div className="text-slate-600 line-clamp-1 text-[10px] flex items-center gap-1"><Icon name="User" size={10}/> {teacher?.name}</div>
                                                                            {item.roomId && <div className="text-[9px] font-mono text-slate-400 bg-white/50 rounded px-1">#{item.roomId}</div>}
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                            
                                                            {items.length < 3 && (
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); handleAddItem(cls.id, p); }}
                                                                    className={`w-full rounded-lg border-2 border-dashed flex items-center justify-center text-slate-300 hover:border-indigo-300 hover:text-indigo-400 transition-colors mt-auto ${items.length === 0 ? 'h-full' : 'h-6'}`}
                                                                >
                                                                    <Icon name="Plus" size={16} />
                                                                </button>
                                                            )}
                                                        </div>
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    )) : (
                                        <tr>
                                            <td colSpan={currentPeriods.length + 1} className="text-center p-10 text-slate-400 italic">
                                                Нет данных для отображения по выбранным фильтрам
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <Modal isOpen={isEditorOpen} onClose={() => setIsEditorOpen(false)} title={tempItem.id ? "Редактировать урок" : "Добавить урок"}>
                        <div className="space-y-5">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">Предмет</label>
                                <select className="w-full border border-slate-200 rounded-xl p-3 text-sm bg-white outline-none focus:border-indigo-500" value={tempItem.subjectId || ''} onChange={e => setTempItem({...tempItem, subjectId: e.target.value, teacherId: ''})}>
                                    <option value="">Выберите...</option>
                                    {data.subjects.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">Направление (группа)</label>
                                <input 
                                    type="text" 
                                    className="w-full border border-slate-200 rounded-xl p-3 text-sm bg-white outline-none focus:border-indigo-500" 
                                    value={tempItem.direction || ''} 
                                    onChange={e => setTempItem({...tempItem, direction: e.target.value})} 
                                    placeholder="Например: 1гр. (оставьте пустым для всего класса)" 
                                />
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">Учитель</label>
                                <select className="w-full border border-slate-200 rounded-xl p-3 text-sm bg-white outline-none focus:border-indigo-500" value={tempItem.teacherId || ''} onChange={e => setTempItem({...tempItem, teacherId: e.target.value})} disabled={!tempItem.subjectId}>
                                    <option value="">Выберите...</option>
                                    {recommendedTeachers.length > 0 && (
                                        <optgroup label="Рекомендуемые (ведут предмет)">
                                            {recommendedTeachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                        </optgroup>
                                    )}
                                    <optgroup label="Остальные">
                                        {otherTeachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                    </optgroup>
                                </select>
                            </div>
                             <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">Кабинет</label>
                                <input type="text" className="w-full border border-slate-200 rounded-xl p-3 text-sm bg-white outline-none focus:border-indigo-500" value={tempItem.roomId || ''} onChange={e => setTempItem({...tempItem, roomId: e.target.value})} />
                            </div>
                            <div className="flex justify-between pt-6 mt-2 border-t border-slate-100">
                                {tempItem.id && <button onClick={handleDeleteItem} className="text-red-500 hover:bg-red-50 px-4 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 transition-colors"><Icon name="Trash2" size={18}/> Удалить</button>}
                                <button onClick={handleSaveItem} className="px-6 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 text-sm font-bold transition-colors ml-auto">Сохранить</button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const AdministrationView = ({ data }) => {
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [afterPeriod, setAfterPeriod] = useState(2);

            const selectedDayOfWeek = useMemo(() => {
                const idx = new Date(selectedDate).getDay();
                if (idx === 0) return null;
                return DAYS[idx - 1];
            }, [selectedDate]);

            const freeTeachers = useMemo(() => {
                if (!selectedDayOfWeek) return [];
                
                return data.teachers.filter(teacher => {
                    // 1. Is absent?
                    if (teacher.unavailableDates.includes(selectedDate)) return false;

                    // 2. Has lessons AFTER the cut-off period?
                    // We check if there are ANY lessons where period > afterPeriod
                    const hasLateLessons = data.schedule.some(s => 
                        s.teacherId === teacher.id && 
                        s.day === selectedDayOfWeek && 
                        s.period > afterPeriod
                    );
                    
                    return !hasLateLessons;
                }).sort((a, b) => a.name.localeCompare(b.name));
            }, [data, selectedDate, selectedDayOfWeek, afterPeriod]);

            return (
                <div className="flex flex-col h-full p-6 bg-slate-50/50">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6 max-w-7xl mx-auto w-full">
                        <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                             <div className="bg-indigo-100 p-2 rounded-lg text-indigo-600"><Icon name="Briefcase" size={24}/></div>
                             Администрация: Поиск свободных учителей
                        </h2>
                        
                        <div className="flex flex-wrap gap-6 items-end">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Дата</label>
                                <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="border border-slate-200 p-3 rounded-xl text-sm font-bold outline-none focus:border-indigo-500" />
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Свободен после урока №</label>
                                <div className="flex items-center gap-2 bg-slate-50 rounded-xl p-1 border border-slate-200">
                                    {[1, 2, 3, 4, 5, 6, 7].map(num => (
                                        <button 
                                            key={num} 
                                            onClick={() => setAfterPeriod(num)}
                                            className={`w-10 h-10 rounded-lg text-sm font-bold transition-all ${afterPeriod === num ? 'bg-indigo-600 text-white shadow' : 'text-slate-500 hover:bg-slate-200'}`}
                                        >
                                            {num}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto max-w-7xl mx-auto w-full custom-scrollbar pr-2">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-10">
                            {freeTeachers.length > 0 ? freeTeachers.map(t => (
                                <div key={t.id} className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4 hover:shadow-md transition-all">
                                    <div className="w-12 h-12 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center font-bold text-lg shrink-0">
                                        <Icon name="Check" size={24} strokeWidth={3}/>
                                    </div>
                                    <div>
                                        <div className="font-bold text-slate-800">{t.name}</div>
                                        <div className="flex flex-wrap gap-1 mt-1">
                                            {t.subjectIds.slice(0, 2).map(sid => {
                                                const s = data.subjects.find(sub => sub.id === sid);
                                                return s ? <span key={sid} className="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-600">{s.name}</span> : null;
                                            })}
                                            {t.subjectIds.length > 2 && <span className="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-600">...</span>}
                                        </div>
                                    </div>
                                </div>
                            )) : (
                                <div className="col-span-full flex flex-col items-center justify-center py-20 text-slate-400">
                                    <Icon name="UserX" size={48} className="mb-4 text-slate-200"/>
                                    <p className="font-medium">Нет свободных учителей по заданным критериям</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SubstitutionView = ({ data, setData }) => {
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentSubParams, setCurrentSubParams] = useState(null);

            const selectedDayOfWeek = useMemo(() => {
                const idx = new Date(selectedDate).getDay();
                if (idx === 0) return null;
                return DAYS[idx - 1];
            }, [selectedDate]);

            const absentTeachers = data.teachers.filter(t => t.unavailableDates.includes(selectedDate));
            
            const affectedLessons = useMemo(() => {
                if (!selectedDayOfWeek) return [];
                const absentIds = absentTeachers.map(t => t.id);
                // Filter schedule items for this day where teacher is absent
                return data.schedule
                    .filter(s => s.day === selectedDayOfWeek && absentIds.includes(s.teacherId))
                    .sort((a, b) => a.period - b.period);
            }, [data.schedule, selectedDayOfWeek, absentTeachers]);

            const handleToggleUnavailable = (id) => {
                const newData = { ...data };
                const t = newData.teachers.find(x => x.id === id);
                if (t.unavailableDates.includes(selectedDate)) {
                    t.unavailableDates = t.unavailableDates.filter(d => d !== selectedDate);
                } else {
                    t.unavailableDates.push(selectedDate);
                }
                setData(newData);
                saveData(newData);
            };

            const handleAssign = (teacherId) => {
                const newData = { ...data };
                // Check if substitution exists
                const existingIdx = newData.substitutions.findIndex(s => s.scheduleItemId === currentSubParams.scheduleItemId && s.date === selectedDate);
                
                const originalScheduleItem = newData.schedule.find(s => s.id === currentSubParams.scheduleItemId);
                
                const sub = {
                    id: existingIdx >= 0 ? newData.substitutions[existingIdx].id : generateId(),
                    date: selectedDate,
                    scheduleItemId: currentSubParams.scheduleItemId,
                    originalTeacherId: originalScheduleItem.teacherId,
                    replacementTeacherId: teacherId
                };
                
                if (existingIdx >= 0) newData.substitutions[existingIdx] = sub;
                else newData.substitutions.push(sub);
                
                setData(newData);
                saveData(newData);
                setIsModalOpen(false);
            };

            const handleDeleteSubstitution = (scheduleItemId) => {
                 if (!window.confirm('Удалить замену?')) return;
                 const newData = { ...data };
                 newData.substitutions = newData.substitutions.filter(s => !(s.scheduleItemId === scheduleItemId && s.date === selectedDate));
                 setData(newData);
                 saveData(newData);
            };

            const getCandidates = () => {
                if (!currentSubParams || !selectedDayOfWeek) return [];
                return data.teachers.map(teacher => {
                    const isAbsent = teacher.unavailableDates.includes(selectedDate);
                    const isBusy = data.schedule.some(s => s.teacherId === teacher.id && s.day === selectedDayOfWeek && s.period === currentSubParams.period && s.shift === currentSubParams.shift);
                    const isSpecialist = teacher.subjectIds.includes(currentSubParams.subjectId);
                    
                    let score = 0;
                    if (isAbsent) score -= 100;
                    if (isBusy) score -= 50;
                    if (isSpecialist) score += 10;

                    return { teacher, isAbsent, isBusy, isSpecialist, score };
                }).sort((a, b) => b.score - a.score);
            };

            return (
                <div className="flex flex-col h-full p-6 bg-slate-50/50">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 h-full max-w-7xl mx-auto w-full">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-fit">
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Дата замены</label>
                            <div className="relative">
                                <Icon name="Calendar" className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/>
                                <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="w-full border border-slate-200 pl-10 p-3 rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-indigo-500" />
                            </div>
                            
                            <div className="mt-8 space-y-4">
                                <h3 className="font-bold text-slate-800 flex items-center gap-2 border-b border-slate-100 pb-2">
                                    <div className="bg-red-100 text-red-600 p-1.5 rounded-lg"><Icon name="UserX" size={18} /></div>
                                    Отсутствующие
                                </h3>
                                <div className="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar pr-1">
                                    {data.teachers.map(t => {
                                        const isAbsent = t.unavailableDates.includes(selectedDate);
                                        return (
                                            <div key={t.id} className={`flex items-center justify-between p-3 border rounded-xl transition-all ${isAbsent ? 'bg-red-50 border-red-100' : 'bg-white border-slate-100'}`}>
                                                <span className={`text-sm font-medium ${isAbsent ? 'text-red-700' : 'text-slate-700'}`}>{t.name}</span>
                                                <button onClick={() => handleToggleUnavailable(t.id)} className={`text-xs px-3 py-1.5 rounded-lg font-bold transition-colors ${isAbsent ? 'bg-white text-red-600 shadow-sm' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                                    {isAbsent ? 'Вернуть' : 'Отметить'}
                                                </button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        <div className="md:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-100 p-6 overflow-hidden flex flex-col">
                            <h2 className="font-bold text-lg text-slate-800 mb-6 flex items-center gap-2">
                                <Icon name="List" size={20} className="text-indigo-600"/>
                                Уроки требующие замены
                            </h2>
                            
                            <div className="overflow-y-auto flex-1 custom-scrollbar pr-2">
                                {affectedLessons.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-400 py-10">
                                        <Icon name="Coffee" size={48} className="mb-4 text-slate-300"/>
                                        <p>Нет уроков для замены на этот день</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {affectedLessons.map(lesson => {
                                            const sub = data.substitutions.find(s => s.scheduleItemId === lesson.id && s.date === selectedDate);
                                            const replacement = sub ? data.teachers.find(t => t.id === sub.replacementTeacherId) : null;
                                            const cls = data.classes.find(c => c.id === lesson.classId);
                                            const subj = data.subjects.find(s => s.id === lesson.subjectId);
                                            
                                            return (
                                                <div key={lesson.id} className="border border-slate-100 p-4 rounded-xl flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-slate-50/30">
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-12 h-12 rounded-xl bg-white border border-slate-200 flex flex-col items-center justify-center shadow-sm text-indigo-600">
                                                            <span className="text-xs font-bold uppercase text-slate-400">Урок</span>
                                                            <span className="text-lg font-black">{lesson.period}</span>
                                                        </div>
                                                        <div>
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className="text-lg font-bold text-slate-800">{cls?.name}</span>
                                                                <span className="text-xs bg-slate-200 px-2 py-0.5 rounded text-slate-600 font-medium">{cls?.shift || Shift.First}</span>
                                                            </div>
                                                            <div className="text-sm text-slate-600 font-medium flex items-center gap-2">
                                                                <span className="w-2 h-2 rounded-full" style={{backgroundColor: subj?.color}}></span>
                                                                {subj?.name}
                                                                {lesson.direction && <span className="text-[10px] bg-white border px-1 rounded text-slate-500">{lesson.direction}</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {replacement ? (
                                                        <div className="flex items-center gap-3 bg-emerald-50 pl-4 pr-2 py-2 rounded-xl border border-emerald-100">
                                                            <div>
                                                                <div className="text-[10px] uppercase font-bold text-emerald-600 tracking-wider mb-0.5">Замена назначена</div>
                                                                <div className="font-bold text-emerald-900 text-sm">{replacement.name}</div>
                                                            </div>
                                                            <button onClick={() => handleDeleteSubstitution(lesson.id)} className="p-2 bg-white rounded-lg text-emerald-200 hover:text-red-500 hover:bg-red-50 transition-colors shadow-sm">
                                                                <Icon name="Trash2" size={16}/>
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <button onClick={() => { setCurrentSubParams({ scheduleItemId: lesson.id, subjectId: lesson.subjectId, period: lesson.period, shift: lesson.shift }); setIsModalOpen(true); }} className="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 transition-all flex items-center gap-2">
                                                            <Icon name="UserCheck" size={18}/>
                                                            Найти замену
                                                        </button>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Выберите замену">
                        <div className="space-y-2 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                            {getCandidates().map(({ teacher, isAbsent, isBusy, isSpecialist }) => (
                                <button 
                                    key={teacher.id} 
                                    disabled={isAbsent || isBusy} 
                                    onClick={() => handleAssign(teacher.id)} 
                                    className={`w-full text-left p-4 border rounded-xl flex justify-between items-center transition-all group
                                        ${isAbsent ? 'bg-red-50 border-red-100 opacity-60 cursor-not-allowed' : 
                                          isBusy ? 'bg-orange-50 border-orange-100 opacity-60 cursor-not-allowed' : 
                                          'bg-white border-slate-100 hover:border-indigo-300 hover:shadow-md cursor-pointer'}`}
                                >
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center shadow-sm font-bold text-lg
                                            ${isAbsent ? 'bg-red-100 text-red-600' : 
                                              isBusy ? 'bg-orange-100 text-orange-600' : 
                                              isSpecialist ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'}`}>
                                            {isAbsent ? 'X' : isBusy ? '!' : isSpecialist ? <Icon name="Star" size={18} fill="currentColor" /> : <Icon name="User" size={18} />}
                                        </div>
                                        <div>
                                            <div className="font-bold text-slate-800">{teacher.name}</div>
                                            <div className="text-xs text-slate-500 flex gap-1">
                                                {isSpecialist && <span className="text-emerald-600 font-medium">Ведет предмет</span>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-xs font-bold px-3 py-1 rounded-lg">
                                        {isAbsent ? <span className="text-red-600 bg-white">Отсутствует</span> : 
                                         isBusy ? <span className="text-orange-600 bg-white">Занят</span> : 
                                         <span className="text-indigo-600 bg-indigo-50 group-hover:bg-indigo-600 group-hover:text-white transition-colors">Выбрать</span>}
                                    </div>
                                </button>
                            ))}
                        </div>
                    </Modal>
                </div>
            );
        };

        const ExportView = ({ data }) => {
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const printRef = useRef(null);
            const [isGenerating, setIsGenerating] = useState(false);

            const handleDownload = async () => {
                if (!printRef.current) return;
                setIsGenerating(true);
                try {
                    await new Promise(resolve => setTimeout(resolve, 100)); // Wait for render
                    const canvas = await html2canvas(printRef.current, { 
                        scale: 2, 
                        backgroundColor: '#ffffff',
                        logging: false
                    });
                    const link = document.createElement('a');
                    link.download = `Замены_${date}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    console.error(e);
                    alert("Ошибка экспорта");
                }
                setIsGenerating(false);
            };
            
            const subs = data.substitutions.filter(s => s.date === date);

            return (
                <div className="p-6 bg-slate-50/50 h-full flex flex-col gap-6 overflow-hidden">
                     <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4 max-w-7xl mx-auto w-full">
                         <div className="flex items-center gap-4">
                             <div className="bg-indigo-50 p-3 rounded-xl text-indigo-600"><Icon name="ImageDown" size={24}/></div>
                             <div>
                                 <h2 className="font-bold text-lg text-slate-800">Экспорт замен</h2>
                                 <p className="text-slate-500 text-sm">Выберите дату для генерации изображения</p>
                             </div>
                         </div>
                         <div className="flex gap-3 w-full sm:w-auto">
                             <input type="date" value={date} onChange={e => setDate(e.target.value)} className="border border-slate-200 p-3 rounded-xl text-sm font-bold outline-none focus:border-indigo-500 flex-1 sm:flex-none" />
                             <button onClick={handleDownload} disabled={isGenerating} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all flex items-center gap-2 disabled:opacity-50">
                                 {isGenerating ? 'Создание...' : <><Icon name="Download" size={20}/> Скачать PNG</>}
                             </button>
                         </div>
                     </div>

                     <div className="flex-1 overflow-auto flex justify-center bg-slate-200/50 rounded-2xl border border-slate-200 p-8 shadow-inner">
                         <div ref={printRef} className="bg-white p-10 shadow-2xl min-h-[800px] w-[900px] text-slate-900 relative">
                             
                             <div className="flex justify-between items-end border-b-2 border-black pb-4 mb-6">
                                 <div>
                                     <h1 className="text-4xl font-black uppercase tracking-tight mb-1">Замена Учителей</h1>
                                     <p className="text-lg text-slate-600 font-medium">Гимназия</p>
                                 </div>
                                 <div className="text-right">
                                     <div className="text-sm text-slate-500 uppercase font-bold tracking-wider">Дата</div>
                                     <div className="text-2xl font-bold">{new Date(date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })}</div>
                                 </div>
                             </div>

                             {subs.length === 0 ? (
                                 <div className="h-64 flex items-center justify-center text-slate-400 italic text-lg border-2 border-dashed border-slate-200 rounded-xl">
                                     Нет замен на этот день
                                 </div>
                             ) : (
                                 <table className="w-full border-collapse text-sm">
                                     <thead>
                                         <tr className="bg-slate-100 border-y-2 border-black">
                                             <th className="p-3 text-center font-black uppercase w-16">Урок</th>
                                             <th className="p-3 text-left font-black uppercase w-24">Класс</th>
                                             <th className="p-3 text-left font-black uppercase">Предмет</th>
                                             <th className="p-3 text-left font-black uppercase w-1/4">Кто отсутствует</th>
                                             <th className="p-3 text-left font-black uppercase w-1/4">Кто заменяет</th>
                                             <th className="p-3 text-center font-black uppercase w-16">Каб.</th>
                                         </tr>
                                     </thead>
                                     <tbody className="divide-y divide-slate-300">
                                         {subs.map(sub => {
                                             const s = data.schedule.find(x => x.id === sub.scheduleItemId);
                                             if (!s) return null;
                                             const cls = data.classes.find(c => c.id === s.classId);
                                             const subj = data.subjects.find(x => x.id === s.subjectId);
                                             const t1 = data.teachers.find(t => t.id === sub.originalTeacherId);
                                             const t2 = data.teachers.find(t => t.id === sub.replacementTeacherId);
                                             return (
                                                 <tr key={sub.id}>
                                                     <td className="p-4 text-center font-bold text-lg">{s.period}</td>
                                                     <td className="p-4 font-bold">{cls?.name}</td>
                                                     <td className="p-4">
                                                         {subj?.name}
                                                         {s.direction && <span className="ml-2 px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded text-xs font-semibold text-slate-600">{s.direction}</span>}
                                                     </td>
                                                     <td className="p-4 text-slate-500 italic line-through decoration-red-500/50">{t1?.name}</td>
                                                     <td className="p-4 font-bold bg-slate-50">{t2?.name}</td>
                                                     <td className="p-4 text-center font-mono">{s.roomId || '-'}</td>
                                                 </tr>
                                             );
                                         })}
                                     </tbody>
                                 </table>
                             )}
                             
                             <div className="mt-10 pt-4 border-t border-slate-200 flex justify-between text-xs text-slate-400">
                                 <div>Сформировано автоматически</div>
                                 <div>Подпись: ____________________</div>
                             </div>
                         </div>
                     </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('schedule');
            const [data, setData] = useState(loadData());
            const fileInputRef = useRef(null);

            const tabs = [
                { id: 'schedule', label: 'Расписание', icon: <Icon name="Calendar" size={18} /> },
                { id: 'substitutions', label: 'Замены', icon: <Icon name="ArrowLeftRight" size={18} /> },
                { id: 'directory', label: 'Справочники', icon: <Icon name="Library" size={18} /> },
                { id: 'admin', label: 'Администрация', icon: <Icon name="Briefcase" size={18} /> },
                { id: 'export', label: 'Экспорт', icon: <Icon name="Download" size={18} /> },
            ];

            const handleExportData = () => {
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `gymnasium_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        // Basic validation
                        if (importedData.teachers && importedData.schedule) {
                            setData(importedData);
                            saveData(importedData);
                            alert('База данных успешно загружена!');
                        } else {
                            alert('Неверный формат файла');
                        }
                    } catch (err) {
                        alert('Ошибка чтения файла');
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="flex flex-col h-screen bg-slate-50 text-slate-900 font-sans">
                    <header className="bg-white border-b border-slate-100 px-6 py-4 flex items-center justify-between shadow-sm z-50">
                        <div className="flex items-center gap-4">
                            <div className="bg-indigo-600 p-2.5 rounded-xl text-white shadow-lg shadow-indigo-200">
                                <Icon name="School" size={24} strokeWidth={2} />
                            </div>
                            <div>
                                <h1 className="text-xl font-black tracking-tight text-slate-800">Гимназия</h1>
                                <p className="text-xs font-semibold text-slate-400 uppercase tracking-wider">Управление расписанием</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                             <input 
                                type="file" 
                                ref={fileInputRef}
                                onChange={handleImportData} 
                                accept=".json" 
                                className="hidden" 
                            />
                            <button onClick={() => fileInputRef.current.click()} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Загрузить базу">
                                <Icon name="Upload" size={20} />
                            </button>
                            <button onClick={handleExportData} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Сохранить базу">
                                <Icon name="Save" size={20} />
                            </button>
                        </div>
                    </header>
                    <Tabs activeTab={activeTab} onChange={setActiveTab} tabs={tabs} />
                    <main className="flex-1 overflow-hidden relative">
                        {activeTab === 'schedule' && <ScheduleView data={data} setData={setData} />}
                        {activeTab === 'substitutions' && <SubstitutionView data={data} setData={setData} />}
                        {activeTab === 'directory' && <DirectoryView data={data} setData={setData} />}
                        {activeTab === 'admin' && <AdministrationView data={data} />}
                        {activeTab === 'export' && <ExportView data={data} />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
